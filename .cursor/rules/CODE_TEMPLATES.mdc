---
alwaysApply: true
---

# Laravel React SPA - Code Templates

This guide provides templates specific to this application's Effect-based React SPA architecture. For general Laravel, PHP, Pest, and Tailwind patterns, see `laravel-boost.mdc`.

---

## Architecture Overview

This is an API-first SPA with:
- **Backend**: Laravel API routes returning Spatie Data objects as JSON
- **Frontend**: React + React Router with Effect-based data loading
- **Auth**: Sanctum tokens + Google OAuth
- **Type Safety**: PHP Data classes auto-transform to TypeScript Effect Schemas

---

## Feature Development Workflow

1. **Database & Models** - migrations, Eloquent models (see laravel-boost.mdc)
2. **Data Layer** - `app/Data/Models/`, `app/Data/Requests/`, `app/Data/Response/`
3. **Business Logic** - Action classes in `app/Actions/`
4. **API Routes** - `routes/api.php`
5. **Frontend** - Update `apiClientSingleton.ts`, create React components with loaders
6. **Routing** - Add routes to `resources/js/router.tsx`

---

## Backend Templates

### Action Classes

Actions are invokable classes that handle a single responsibility. Place in `app/Actions/{Domain}/`.

**Show Action** (`app/Actions/Content/ShowContent.php`):

```php
<?php

declare(strict_types=1);

namespace App\Actions\Content;

use App\Data\Models\ContentData;
use App\Data\Response\ContentItems;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class ShowContent
{
    public function __invoke(Request $request): JsonResponse
    {
        $items = Content::query()
            ->with(['relationships']) // Eager load
            ->orderBy('created_at', 'desc')
            ->get();

        return response()->json(ContentItems::from([
            'content' => ContentData::collect($items),
        ]));
    }
}
```

**Create Action with Validation** (`app/Actions/Auth/Login.php` pattern):

```php
<?php

declare(strict_types=1);

namespace App\Actions\Auth;

use App\Data\Requests\LoginRequest;
use App\Data\Response\AuthResponse;
use Symfony\Component\HttpFoundation\Response;

class Login
{
    public function __invoke(LoginRequest $data): Response
    {
        // Business logic here...
        
        return response()->json(AuthResponse::from([
            'token' => $token,
            'user' => $user,
        ]));
    }
}
```

### Data Models

Data transfer objects in `app/Data/Models/`. These auto-generate TypeScript Effect Schemas.

```php
<?php

declare(strict_types=1);

namespace App\Data\Models;

use Illuminate\Support\Carbon;
use Spatie\LaravelData\Data;

class ContentData extends Data
{
    public function __construct(
        public int $id,
        public string $title,
        public string $body,
    ) {}
}
```

**With Relationships and Lazy Loading**:

```php
<?php

declare(strict_types=1);

namespace App\Data\Models;

use Illuminate\Support\Carbon;
use Illuminate\Support\Collection;
use Spatie\LaravelData\Attributes\AutoWhenLoadedLazy;
use Spatie\LaravelData\Data;
use Spatie\LaravelData\Lazy;

class UserData extends Data
{
    public function __construct(
        public string $id,
        public string|null $name,
        public string|null $email,
        public Carbon|null $created_at,
        public Carbon|null $updated_at,
        
        // Lazy-loaded relationships
        #[AutoWhenLoadedLazy]
        public Lazy|ProfileData $profile,
        
        /** @var Collection<array-key,PostData> $posts */
        #[AutoWhenLoadedLazy('posts')]
        public Collection|Lazy $posts,
    ) {}
}
```

### Response Classes

Wrapper classes in `app/Data/Response/` for consistent API responses.

**Collection Response**:

```php
<?php

declare(strict_types=1);

namespace App\Data\Response;

use App\Data\Models\ContentData;
use Illuminate\Support\Collection;
use Spatie\LaravelData\Data;

class ContentItems extends Data
{
    public function __construct(
        /** @var Collection<array-key,ContentData> $content */
        public Collection $content,
    ) {}
}
```

**Single Item Response**:

```php
<?php

declare(strict_types=1);

namespace App\Data\Response;

use App\Data\Models\UserData;
use Spatie\LaravelData\Data;

class AuthResponse extends Data
{
    public function __construct(
        public string $token,
        public UserData $user,
    ) {}
}
```

### Request Validation Classes

Validation in `app/Data/Requests/` using Spatie Data attributes.

```php
<?php

declare(strict_types=1);

namespace App\Data\Requests;

use Spatie\LaravelData\Attributes\Validation\Confirmed;
use Spatie\LaravelData\Attributes\Validation\Email;
use Spatie\LaravelData\Attributes\Validation\Max;
use Spatie\LaravelData\Attributes\Validation\Min;
use Spatie\LaravelData\Attributes\Validation\Required;
use Spatie\LaravelData\Attributes\Validation\StringType;
use Spatie\LaravelData\Attributes\Validation\Unique;
use Spatie\LaravelData\Data;

class RegisterRequest extends Data
{
    public function __construct(
        #[Required]
        #[StringType]
        #[Min(2)]
        #[Max(255)]
        public string $name,

        #[Required]
        #[Email]
        #[Max(255)]
        #[Unique(table: 'users', column: 'email')]
        public string $email,

        #[Required]
        #[StringType]
        #[Min(8)]
        #[Confirmed]
        public string $password,

        #[Required]
        #[StringType]
        public string $password_confirmation,
    ) {}
}
```

**Common Validation Attributes**:
- `#[Required]` - Field must be present
- `#[StringType]`, `#[IntegerType]`, `#[BooleanType]` - Type constraints
- `#[Email]` - Valid email format
- `#[Min(n)]`, `#[Max(n)]` - Length/value constraints
- `#[Confirmed]` - Requires matching `{field}_confirmation`
- `#[Unique(table: 'x', column: 'y')]` - Database uniqueness
- `#[Exists(table: 'x', column: 'y')]` - Database existence

### API Routes

Routes in `routes/api.php` are prefixed with `/api/`.

```php
<?php

use Illuminate\Support\Facades\Route;

// Public routes
Route::post('/login', App\Actions\Auth\Login::class)->name('api.login');
Route::post('/register', App\Actions\Auth\Register::class)->name('api.register');
Route::get('/content', App\Actions\Content\ShowContent::class)->name('api.content');

// Authenticated routes
Route::middleware('auth:sanctum')->group(function () {
    Route::get('/user', App\Actions\Auth\ShowUser::class)->name('api.user');
    Route::post('/logout', App\Actions\Auth\Logout::class)->name('api.logout');
});
```

---

## Frontend Templates

### ApiClient Singleton

The API client uses `@effect/platform` HttpApiClient. Add new endpoints in `resources/js/lib/apiClientSingleton.ts`.

**1. Define the API group**:

```typescript
const contentGroup = HttpApiGroup.make('content').add(
    HttpApiEndpoint.get('show', '/api/content').addSuccess(ContentItemsSchema),
);

// For POST with payload:
const authGroup = HttpApiGroup.make('auth')
    .add(
        HttpApiEndpoint.post('login', '/api/login')
            .setPayload(LoginRequestSchema)
            .addSuccess(AuthResponseSchema),
    );
```

**2. Register in the API definition**:

```typescript
export const Api = HttpApi.make('BackendApi')
    .add(authGroup)
    .add(contentGroup)
    .addError(ValidationErrorSchema, { status: 422 });
```

**3. Add public method to ApiClientSingleton**:

```typescript
class ApiClientSingleton {
    // For public endpoints (no auth)
    async showContent() {
        const client = await this.getBaseClient();
        return this.runEffect(client.content.show());
    }

    // For authenticated endpoints
    async showUser() {
        const client = await this.getBaseAuthClient();
        return this.runEffect(client.users.show());
    }

    // With payload
    async login(payload: LoginRequest) {
        const client = await this.getBaseClient();
        return this.runEffect(client.auth.login({ payload }));
    }
}
```

### React Router Loader

Loaders fetch data before rendering. Export from the page component file.

**Public Route Loader**:

```typescript
export async function contentLoader() {
    const result = await ApiClient.showContent();
    if (result._tag === 'Success') {
        return result.data;
    }
    // Handle error or return empty state
    console.error('Failed to load content:', result);
    return { content: [] };
}
```

**Authenticated Route Loader with Redirect**:

```typescript
import { redirect } from 'react-router-dom';
import { authManager } from '@/lib/auth';

export async function profileLoader() {
    let user = authManager.getUser();
    let token = authManager.getToken();

    // Try to restore from session if no local token
    if (!user || !token) {
        const result = await ApiClient.fetchSessionToken();
        if (result._tag === 'Success') {
            authManager.setAuthData(result.data.token, result.data.user);
            user = result.data.user;
            token = result.data.token;
        }
    }

    if (!user || !token) {
        return redirect('/login');
    }

    return user;
}
```

### React Page Component

```tsx
import { useLoaderData } from 'react-router-dom';
import { ContentItems } from '@/types/effect-schemas';

export function ContentPage() {
    const { content } = useLoaderData<ContentItems>();

    return (
        <div className="mx-auto max-w-4xl">
            <h1 className="mb-8 text-3xl font-bold">Content</h1>

            {content.length > 0 ? (
                <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {content.map((item) => (
                        <div key={item.id} className="bg-card rounded-lg p-6 shadow-md">
                            <h2 className="mb-2 text-xl font-semibold">{item.title}</h2>
                            <p className="text-secondary">{item.body}</p>
                        </div>
                    ))}
                </div>
            ) : (
                <p className="text-secondary">No content available.</p>
            )}
        </div>
    );
}
```

### Router Configuration

Add routes in `resources/js/router.tsx`:

```tsx
import { createBrowserRouter } from 'react-router-dom';
import { App } from './app';
import { ContentPage, contentLoader } from './features/content/ContentPage';
import { ProfilePage, profileLoader } from './features/profile/ProfilePage';
import { ErrorPage } from './features/ErrorPage';

export const router = createBrowserRouter([
    {
        path: '/',
        element: <App />,
        children: [
            {
                index: true,
                element: <HomePage />,
            },
            {
                path: 'content',
                element: <ContentPage />,
                loader: contentLoader,
                errorElement: <ErrorPage />,
            },
            {
                path: 'profile',
                element: <ProfilePage />,
                loader: profileLoader,
                errorElement: <ErrorPage />,
            },
        ],
    },
]);
```

---

## TypeScript Schema Generation

PHP Data classes auto-generate Effect Schemas in `resources/js/types/effect-schemas.ts`.

Run generation after changing Data classes:

```bash
php artisan typescript:transform
```

The generated schemas provide runtime validation and TypeScript types:

```typescript
// Auto-generated from ContentData.php
export const ContentDataSchema = Schema.Struct({
    id: Schema.Number,
    title: Schema.String,
    body: Schema.String,
});

export type ContentData = Schema.Schema.Type<typeof ContentDataSchema>;
```

---

## Auth Patterns

### Using AuthContext

```tsx
import { useAuth } from '@/contexts/AuthContext';

function MyComponent() {
    const { user, login, logout, isLoading } = useAuth();

    if (!user) {
        return <p>Not logged in</p>;
    }

    return <p>Welcome, {user.name}</p>;
}
```

### API Result Handling

All ApiClient methods return a tagged union result:

```typescript
const result = await ApiClient.login(credentials);

switch (result._tag) {
    case 'Success':
        // result.data contains the response
        authManager.setAuthData(result.data.token, result.data.user);
        break;
    case 'ValidationError':
        // result.errors is Record<string, string[]>
        setErrors(result.errors);
        break;
    case 'ParseError':
    case 'FatalError':
        // result.message contains error details
        console.error(result.message);
        break;
}
```

---

## Feature Checklist

When adding a new feature:

- [ ] Create migration (if needed)
- [ ] Create/update Eloquent model
- [ ] Create Data model class (`app/Data/Models/`)
- [ ] Create Request validation class (`app/Data/Requests/`)
- [ ] Create Response class (`app/Data/Response/`)
- [ ] Create Action class(es) (`app/Actions/`)
- [ ] Add API route(s) to `routes/api.php`
- [ ] Add endpoint to `apiClientSingleton.ts`
- [ ] Create React component with loader
- [ ] Add route to `router.tsx`
- [ ] Write Pest tests
